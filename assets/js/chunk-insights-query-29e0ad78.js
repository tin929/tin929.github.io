System.register(["./chunk-frameworks.js","./chunk-vendor.js"],(function(){"use strict";var e,i;return{setters:[function(a){e=a.a,i=a.t},function(){}],execute:function(){const a={bubbles:!0,cancelable:!0};class t extends HTMLElement{constructor(){super(...arguments),this.currentQueryId=0}connectedCallback(){this.executeQuery()}static get observedAttributes(){return["query","api-url","auth-url"]}attributeChangedCallback(){this.autoRender&&this.executeQuery()}get autoRender(){return this.hasAttribute("auto-render")}set autoRender(e){e?this.setAttribute("auto-render",""):this.removeAttribute("auto-render")}get query(){let e=this.getAttribute("query");if(e)return e;const i=this.getAttribute("query-container-id");if(i){const a=document.getElementById(i);a&&(e=a instanceof HTMLInputElement?a.value:a.textContent)}return e}set query(e){e?this.setAttribute("query",e):this.removeAttribute("query")}get apiUrl(){return this.getAttribute("api-url")}set apiUrl(e){e?this.setAttribute("api-url",e):this.removeAttribute("api-url")}get authUrl(){return this.getAttribute("auth-url")}set authUrl(e){e?this.setAttribute("auth-url",e):this.removeAttribute("auth-url")}async executeQuery(){const e=(new Date).getTime(),{query:i,render:o}=this.parseQuery(),u=this.apiUrl;if(!u||!i||!o)return;const c=["series-table","line-chart","stacked-area-chart"];if(0===this.children.length){if(!c.includes(o))throw this.innerHTML=function(e="Error loading data",i="Unable to render chart."){return`<div class="blankslate color-bg-tertiary rounded-1 d-flex flex-column flex-items-center flex-justify-center height-full">\n  <svg\n    aria-hidden="true"\n    height="24"\n    viewBox="0 0 24 24"\n    version="1.1"\n    width="24"\n    class="octicon octicon-graph blankslate-icon"\n  >\n    <path d="M2.5 2.75a.75.75 0 00-1.5 0v18.5c0 .414.336.75.75.75H20a.75.75 0 000-1.5H2.5V2.75z"></path>\n    <path\n      d="M22.28 7.78a.75.75 0 00-1.06-1.06l-5.72 5.72-3.72-3.72a.75.75 0 00-1.06 0l-6 6a.75.75 0 101.06 1.06l5.47-5.47 3.72 3.72a.75.75 0 001.06 0l6.25-6.25z"\n    ></path>\n  </svg>\n\n  <h3 class="mb-1">${e}</h3>\n\n  <p>${i}</p>\n</div>`}(),this.dispatchEvent(new CustomEvent("insights-query-datadog-telemetry",Object.assign(Object.assign({},a),{detail:{incrementKey:"execute-error"}}))),new s(`Query contains unknown render type: ${o}`);this.appendChild(document.createElement(o))}const h=this.currentQueryId+1;this.currentQueryId=h,this.renderLoading(h);const d=(new Date).getTime(),{token:l,scope:g,organization:y}=await this.fetchTokenAndScope(),m=(new Date).getTime();l&&g&&y&&await this.fetchQuery({authQueryTime:m-d,apiUrl:u,organization:y,query:i,scope:g,startTime:e,token:l,queryId:h})}async fetchQuery(e){try{const i=(new Date).getTime(),o=await fetch(e.apiUrl,{method:"POST",body:JSON.stringify({query:e.query}),headers:{Authorization:e.token,"X-Auth-Scope":e.scope,"Content-Type":"application/json"}}),u=(new Date).getTime();if(200!==o.status)throw new Error(`Insights API returned status code: ${o.status}`);const c=await o.json(),{data:h,errors:d}=c;if(!h||!d)throw new Error("Either no data is returned or data response has changed");if(d&&d.hasErrors)throw new Error(`Insights API Error: ${d.errorMessage}`);const l=this.formatData(h);this.renderSeries(e.queryId,l);const g=(new Date).getTime();this.dispatchEvent(new CustomEvent("insights-query-datadog-telemetry",Object.assign(Object.assign({},a),{detail:{incrementKey:"execute-success"}}))),this.dispatchEvent(new CustomEvent("insights-query-hydro-telemetry",Object.assign(Object.assign({},a),{detail:{incrementKey:"execute-success",context:{organization:e.organization,"insights.render.time":g-e.startTime,"api.query.time":u-i,"auth.query.time":e.authQueryTime}}})))}catch(r){const o=r;throw this.dispatchEvent(new CustomEvent("insights-query-datadog-telemetry",Object.assign(Object.assign({},a),{detail:{incrementKey:"execute-error"}}))),this.dispatchEvent(new CustomEvent("insights-query-hydro-telemetry",Object.assign(Object.assign({},a),{detail:{incrementKey:"execute-error",context:{organization:e.organization,"auth.query.time":e.authQueryTime}}}))),this.renderError(e.queryId),new n(o.message)}}async fetchTokenAndScope(){const e=this.authUrl;if(!e)return{token:null,scope:null,organization:null};try{const i=await fetch(e,{headers:{Accept:"application/json"}}),{token:a,scope:o,organization:u}=await i.json();return{token:a,scope:o,organization:u}}catch(e){const i=e;throw this.dispatchEvent(new CustomEvent("insights-query-datadog-telemetry",Object.assign(Object.assign({},a),{detail:{incrementKey:"token-fetch-error"}}))),this.dispatchEvent(new CustomEvent("insights-query-hydro-telemetry",Object.assign(Object.assign({},a),{detail:{incrementKey:"token-fetch-error"}}))),new r(i.message)}}formatData(e){return[e.columns.map((e=>e.name)),...e.rows]}parseQuery(){const e=this.query;if(!e)return{query:null,render:null};const i=e.match(/--\s*render\s+(?<render>[^\s]+)/i);return{query:e,render:i&&void 0!==i.groups?i.groups.render:"series-table"}}renderError(e,i){if(this.currentQueryId===e)for(const a of Array.from(this.children))a.setAttribute("error",encodeURI(i||"")),a.removeAttribute("loading")}renderLoading(e){if(this.currentQueryId===e)for(const i of Array.from(this.children))i.setAttribute("loading",""),i.removeAttribute("error")}renderSeries(e,i){if(this.currentQueryId!==e)return;const a=encodeURI(JSON.stringify(i));for(const o of Array.from(this.children))o.setAttribute("series",a),o.removeAttribute("loading"),o.removeAttribute("error")}}class r extends Error{constructor(e){super(e),this.name="InsightsTokenFetchError"}}class n extends Error{constructor(e){super(e),this.name="InsightsDataFetchError"}}class s extends Error{constructor(e){super(e),this.name="InsightsQueryStatementError"}}window.customElements.get("insights-query")||(window.InsightsQueryElement=t,window.InsightsTokenFetchError=r,window.InsightsDataFetchError=n,window.InsightsQueryStatementError=s,window.customElements.define("insights-query",t)),window.addEventListener("insights-query-datadog-telemetry",(i=>{const a={};let o=i.detail.incrementKey;if(o){o=`INSIGHTS_QUERY_${o.replace(/-/g,"_").toUpperCase()}`;const e=o;e&&(a.incrementKey=e)}Object.keys(a).length>0&&e(a)})),window.addEventListener("insights-query-hydro-telemetry",(e=>{const a=e;let o=a.detail.incrementKey;o&&(o=`INSIGHTS_QUERY_${o.replace(/-/g,"_").toUpperCase()}`),i(o,a.detail.context||{})}))}}}));
//# sourceMappingURL=chunk-insights-query-b4e82e25.js.map
